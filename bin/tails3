#!/usr/bin/env node

var nopt = require('nopt');
var tails3 = require('../lib/tails3')
var colors = require('colors');
var strftime = require('strftime');

function asUTC(d){
    return new Date(
        d.getUTCFullYear(),
        d.getUTCMonth(),
        d.getUTCDate(),
        d.getUTCHours(),
        d.getUTCMinutes(),
        d.getUTCSeconds()
    );
}

function lengthlimit(line, length){
    length = length || 160;
    if(line.length > length-3)
        line = line.substr(0, length-3) + '...';
    return line;
}

function applyColor(color, line){
    return line[color];
}

function logLine(color, isdebug, ts, line){
    var stack   = line.stack;
    var host    = line.hostname;
    var level   = line.level;
    var message = line.message;

    if(message) message = lengthlimit(line.message);
    if(stack) stack = stack.replace(/\\n/g, '\n');

    ts = strftime("%Y/%m/%d %H:%M:%S.%L", ts);
    
    if(typeof color === 'undefined'){
        console.log(applyColor('bold', '[' + ts +' '+ level +' '+ host + '] ') + message);
    }else if(isdebug){
        console.log(applyColor('bold', '[' + ts +' '+ level +' '+ host + '] ') + applyColor('grey', message));
    }else{
        console.log(applyColor(color, applyColor('bold', '[' + ts +' '+ level +' '+ host + '] ') + message));
    }
    if(stack)
        console.log(stack[color]);
}

function main(){
    process.title = 'tails3';

    var opts = {
        "bucket":String,
        "stage":String,
        "since":String
    };
    var shorthands = {
        "b": ["--bucket"]
    };
    var parsed = nopt(opts, shorthands);

    if(!parsed.bucket)
        throw new Error('--bucket is required');
    if(parsed.since && parsed.since.split('-').length != 5)
        throw new Error('--since must be of the form YYYY-mm-DD-HH-MM');

    var one_hour_ago_as_utc = asUTC(tails3.oneHourAgo());
    var one_hour_ago_strffed = tails3.bucketDateFormat(one_hour_ago_as_utc);

    var stage  = parsed.stage || 'production';
    var bucket = parsed.bucket;
    var since  = parsed.since || one_hour_ago_strffed;
    
    // need to get files up to an hour older than the time we care about, as
    // files can contain hour-old data
    var sp = since.split("-");
    var since_minus_one_hour = new Date(sp[0], sp[1]-1, sp[2], sp[3] - 1, sp[4]);
    var since_minus_one_hour_strffed = tails3.bucketDateFormat(since_minus_one_hour);

    var s = new tails3.BucketFileStream(bucket, since_minus_one_hour_strffed, stage);
    
    s.on('file', function(f){console.log('new file:', f);});
    s.on('error', function(e){console.log('error:', e);});


    //tails3.getLogDataInRange(bucket, since_minus_one_hour_strffed, '9999-99-99-99-99', stage, function(err, log_objects){
    //    if(err) throw err;
    //    log_objects.forEach(function(line){
    //        var ts = new Date(line.timestamp);
    //        var ts_as_utc = asUTC(ts);
    //        var ts_as_utc_strffed = tails3.bucketDateFormat(ts_as_utc)
    //        var level = line.level;
    //        
    //        if(ts_as_utc_strffed > since){
    //            if(level == 'critical'){
    //                logLine('magenta', false, ts, line);
    //            }else if(level == 'error'){
    //                logLine('red', false, ts, line);
    //            }else if(level == 'warn'){
    //                logLine('yellow', false, ts, line);
    //            }else if(level == 'debug'){
    //                logLine(undefined, true, ts, line);
    //            }else{
    //                logLine(undefined, false, ts, line);
    //            }
    //        }
    //    });
    //});
}

main();
